name: Create Repository and Push .net8

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Nombre del nuevo repositorio'
        required: true
      name_solution: 
        description: 'Nombre de la soluciÃ³n'
        required: true
      name_project: 
        description: 'Nombre del proyecto'
        required: true
      private:
        description: 'Â¿El repositorio debe ser privado? (true/false)'
        required: true
        default: 'true'
      port_payload:
        required: true
        description: Port's payload, including details for who triggered the action and
          general context (blueprint, run id, etc...)
        type: string

jobs:    
  create-and-push:
    name: Create Repository and Push Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      DOTNET_VERSION: '8.0.0'  # Define la versiÃ³n de .NET como una variable de entorno
    steps:
      - uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          identifier: ${{ github.sha }}
          title: ${{ github.event.inputs.repo_name }}
          blueprint: ciJob
          properties: |-
            {
              "triggeredBy": "${{ github.actor }}",
              "commitHash": "${{ github.sha }}",
              "jobBranch": "${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}",
              "runLink": "${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}",
              "RepoLink": "https://github.com/${{ github.repository_owner }}/${{ github.event.inputs.repo_name }}.git"
            }

      - name: Log message
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_payload).context.runId}}
          logMessage: Creando el repositorio ðŸ› ï¸

  
      
      - name: Log message
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_payload).context.runId}}
          logMessage: Repositorio creado satisfactoriamente âœ…  

      - name: Log message
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_payload).context.runId}}
          logMessage: Instalando node âŒ›ï¸  
      

      - name: Setup node
        uses: actions/setup-node@v4
        
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 8.0.x

      - name: Log message
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{fromJson(inputs.port_payload).context.runId}}
          logMessage: InstalaciÃ³n de Node terminadaâœ…  

      - name: Create solution and installation of the tool
        run: |
          npm i -g azure-functions-core-tools@4 --unsafe-perm true
          dotnet new sln -o ${{ github.event.inputs.name_solution }}

      - name: Create project directories
        run: |
          cd ${{ github.event.inputs.name_solution }}
          mkdir -p 01.${{ github.event.inputs.name_project }}.Api/${{ github.event.inputs.name_project }}.Function
          mkdir -p 02.${{ github.event.inputs.name_project }}.Application
          mkdir -p 03.${{ github.event.inputs.name_project }}.Domain
          mkdir -p 04.${{ github.event.inputs.name_project }}.Infrastructure
          mkdir -p 05.${{ github.event.inputs.name_project }}.Test

      - name: Create function project
        run: |
          cd ${{ github.event.inputs.name_solution }}/01.${{ github.event.inputs.name_project }}.Api/${{ github.event.inputs.name_project }}.Function
          func new --name ${{ github.event.inputs.name_project }}.Function --template "HTTP trigger" --authlevel "anonymous" --worker-runtime dotnet --language C#
          cd ../../../

      - name: Create application project
        run: |
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/02.${{ github.event.inputs.name_project }}.Application/${{ github.event.inputs.name_project }}.Application

      - name: Create domain project
        run: |
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/03.${{ github.event.inputs.name_project }}.Domain/${{ github.event.inputs.name_project }}.Domain

      - name: Create infrastructure projects
        run: |
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Agents
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.ExternalService
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Persistence
          dotnet new classlib -o ${{ github.event.inputs.name_solution }}/04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Common

      - name: Create test project
        run: |
          dotnet new xunit -o ${{ github.event.inputs.name_solution }}/05.${{ github.event.inputs.name_project }}.Test/${{ github.event.inputs.name_project }}.Tests

      - name: Add projects to solution
        run: |
          cd ${{ github.event.inputs.name_solution }}
          dotnet sln add 01.${{ github.event.inputs.name_project }}.Api/${{ github.event.inputs.name_project }}.Function/${{ github.event.inputs.name_project }}_Function.csproj
          dotnet sln add 02.${{ github.event.inputs.name_project }}.Application/${{ github.event.inputs.name_project }}.Application/${{ github.event.inputs.name_project }}.Application.csproj
          dotnet sln add 03.${{ github.event.inputs.name_project }}.Domain/${{ github.event.inputs.name_project }}.Domain/${{ github.event.inputs.name_project }}.Domain.csproj
          dotnet sln add 04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Agents/${{ github.event.inputs.name_project }}.Infrastructure.Agents.csproj
          dotnet sln add 04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.ExternalService/${{ github.event.inputs.name_project }}.Infrastructure.ExternalService.csproj
          dotnet sln add 04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Persistence/${{ github.event.inputs.name_project }}.Infrastructure.Persistence.csproj
          dotnet sln add 04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Common/${{ github.event.inputs.name_project }}.Infrastructure.Common.csproj
          dotnet sln add 05.${{ github.event.inputs.name_project }}.Test/${{ github.event.inputs.name_project }}.Tests/${{ github.event.inputs.name_project }}.Tests.csproj

      - name: Add dependencies to application project
        run: |
          cd ${{ github.event.inputs.name_solution }}/02.${{ github.event.inputs.name_project }}.Application/${{ github.event.inputs.name_project }}.Application
          dotnet add package AutoMapper
          dotnet add package Newtonsoft.Json

      - name: Add dependencies to domain project
        run: |
          cd ${{ github.event.inputs.name_solution }}/03.${{ github.event.inputs.name_project }}.Domain/${{ github.event.inputs.name_project }}.Domain
          dotnet add package FluentValidation

      - name: Add dependencies to infrastructure projects
        run: |
          cd ${{ github.event.inputs.name_solution }}/04.${{ github.event.inputs.name_project }}.Infrastructure/${{ github.event.inputs.name_project }}.Infrastructure.Persistence
          dotnet add package AutoMapper.Extensions.Microsoft.DependencyInjection 
          dotnet add package Microsoft.EntityFrameworkCore --version ${{ env.DOTNET_VERSION }}
          dotnet add package Microsoft.EntityFrameworkCore.Design --version ${{ env.DOTNET_VERSION }}
          dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version ${{ env.DOTNET_VERSION }}
          dotnet add package Microsoft.EntityFrameworkCore.Tools --version ${{ env.DOTNET_VERSION }}
          cd ..
          cd ${{ github.event.inputs.name_project }}.Infrastructure.Agents
          dotnet add package Microsoft.Extensions.Configuration --version ${{ env.DOTNET_VERSION }}
          dotnet add package Microsoft.Extensions.Http --version ${{ env.DOTNET_VERSION }}
          dotnet add package Newtonsoft.Json
          dotnet add package Polly

      - name: Add dependencies to test project
        run: |
          cd ${{ github.event.inputs.name_solution }}/05.${{ github.event.inputs.name_project }}.Test/${{ github.event.inputs.name_project }}.Tests
          dotnet add package Moq

      - name: Add Swagger dependencies and configuration to function project
        run: |
          cd ${{ github.event.inputs.name_solution }}/01.${{ github.event.inputs.name_project }}.Api/${{ github.event.inputs.name_project }}.Function
          dotnet add package Swashbuckle.AspNetCore
          
          # Create Startup.cs file
          echo 'using Microsoft.Azure.Functions.Extensions.DependencyInjection;' > Startup.cs
          echo 'using Microsoft.Extensions.DependencyInjection;' >> Startup.cs
          echo 'using Microsoft.OpenApi.Models;' >> Startup.cs
          echo 'using Swashbuckle.AspNetCore.SwaggerGen;' >> Startup.cs
          echo 'using System.Reflection;' >> Startup.cs
          echo '' >> Startup.cs
          echo '[assembly: FunctionsStartup(typeof(${github.event.inputs.name_project}.Function.Startup))]' >> Startup.cs
          echo '' >> Startup.cs
          echo 'namespace ${github.event.inputs.name_project}.Function' >> Startup.cs
          echo '{' >> Startup.cs
          echo '    public class Startup : FunctionsStartup' >> Startup.cs
          echo '    {' >> Startup.cs
          echo '        public override void Configure(IFunctionsHostBuilder builder)' >> Startup.cs
          echo '        {' >> Startup.cs
          echo '            builder.Services.AddSwaggerGen(c =>' >> Startup.cs
          echo '            {' >> Startup.cs
          echo '                c.SwaggerDoc("v1", new OpenApiInfo { Title = "${github.event.inputs.name_project} API", Version = "v1" });' >> Startup.cs
          echo '                var xmlFile = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";' >> Startup.cs
          echo '                var xmlPath = System.IO.Path.Combine(System.AppContext.BaseDirectory, xmlFile);' >> Startup.cs
          echo '                c.IncludeXmlComments(xmlPath);' >> Startup.cs
          echo '            });' >> Startup.cs
          echo '        }' >> Startup.cs
          echo '    }' >> Startup.cs
          echo '}' >> Startup.cs

          # Create FunctionExtensions.cs file
          echo 'using Microsoft.Azure.Functions.Extensions.DependencyInjection;' > FunctionExtensions.cs
          echo 'using Microsoft.OpenApi.Models;' >> FunctionExtensions.cs
          echo 'using Swashbuckle.AspNetCore.SwaggerGen;' >> FunctionExtensions.cs
          echo 'using System.Linq;' >> FunctionExtensions.cs
          echo 'using Microsoft.Azure.WebJobs;' >> FunctionExtensions.cs
          echo 'using Microsoft.Azure.WebJobs.Hosting;' >> FunctionExtensions.cs
          echo '' >> FunctionExtensions.cs
          echo 'namespace ${github.event.inputs.name_project}.Function' >> FunctionExtensions.cs
          echo '{' >> FunctionExtensions.cs
          echo '    public class FunctionExtensions : IWebJobsStartup' >> FunctionExtensions.cs
          echo '    {' >> FunctionExtensions.cs
          echo '        public void Configure(IWebJobsBuilder builder)' >> FunctionExtensions.cs
          echo '        {' >> FunctionExtensions.cs
          echo '            builder.AddSwashbuckle(Assembly.GetExecutingAssembly());' >> FunctionExtensions.cs
          echo '        }' >> FunctionExtensions.cs
          echo '    }' >> FunctionExtensions.cs
          echo '}' >> FunctionExtensions.cs
          
      - name: Restore NuGet packages
        run: |
          cd ${{ github.event.inputs.name_solution }}
          dotnet restore
          
      - name: Build the solution
        run: |
          cd ${{ github.event.inputs.name_solution }}
          dotnet build
          
      - name: Create New Repository
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB_ACCTION }}  # Utiliza el token de GitHub para autenticar
        run: |
          curl -X POST -H "Authorization: token ${GITHUB_TOKEN}" \
               -d '{"name":"${{ github.event.inputs.repo_name }}", "private":${{ github.event.inputs.private }}}' \
               https://api.github.com/orgs/castor-prueba/repos
        
      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB_ACCTION }}
        run: |
          curl -X POST -H "Authorization: token ${GITHUB_TOKEN}" \
               -d '{"name":"${{ github.event.inputs.repo_name }}", "private":${{ github.event.inputs.private }}}' \
               https://api.github.com/orgs/castor-prueba/repos
          
          ls -la
          cd ${{ github.event.inputs.name_solution }}
          git config --global user.email "jhoan.rojas@mercurio.com.co"
          git config --global user.name "JhoanDRojas"
          rm -rf .git/
          git init
          git add .
          git commit -m "Initial commit"
          git branch -M main
          git remote add origin https://$GITHUB_TOKEN@github.com/castor-prueba/${{ github.event.inputs.repo_name }}.git
          git push -f origin main
